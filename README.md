# WhatsApp - System Design

Домашнее задание для курса по [System Design](https://balun.courses/courses/system_design).



### Функциональные требования:

- Сезонности у системы нет
- Системой будут пользоваться по всему миру
- Приложение будет показывать непрочитанные сообщения
- Приложение будет поддерживать чаты и личные сообщения
- Отправлять можно только текст и картинки в сообщениях
- Максимальный размер изображения в сообщении = 500 КБ
- Максимальное кол-во изображений в сообщении = 3
- Максимальный размер текста в сообщении = 2000 символов
- Клиентами будут мобильные, десктопные и WEB приложения
- 200 000 000 уникальных пользователей будут заходить в приложение каждый день
- Каждый пользователь в среднем будет отправлять 10 сообщений в день
- Каждый пользователь в среднем будет просматривать сообщения 20 раз в день
- Система должна работать 24 на 7 (*допустимо несколько часов простоя в год*)
- Приложение должно будет показывать статусы онлайн/оффлайн пользователей, а также когда пользователь был последний раз в сети
- Сообщение до получателя должно успевать доходить за 3 секунды (*если пользователя нет в сети - ему должно прийти Push уведомление на мобильный телефон*);
- Приложение должно поддерживать кросс-девайсную синхронизацию (*если у вас это приложение открыто на телефоне и ноутбуке, и например вы прочитали сообщение на телефоне, то сообщение должно отобразиться прочитанным и на ноутбуке*)

## Обзор дизайна

Для построения архитектуры приложения я использовал [C4 модель](https://c4model.com/).

<p align="center">
    </br><b>Level 1.</b> System context diagram</br></br>
</p>

<p align="center">
  <img src="images/diagrams/context.svg" />
</p>

<p align="center">
    </br><b>Level 2.</b> Core system container diagram</br></br>
</p> 

<p align="center">
  <img src="images/diagrams/containers/core_system.svg" />
</p>

<p align="center">
    </br><b>Level 2.</b> Analytics system container diagram</br></br>
</p> 

<p align="center">
  <img src="images/diagrams/containers/analytics_system.svg" />
</p>

## Базовые расчёты системы

RPS (отправка сообщений пользователем):

    DAU = 200 000 000
    Каждый пользователь в среднем отправляет 10 сообщений в сутки:
    RPS = 200 000 000 * 10 / 24 / 60 / 60 ~= 23 200 

RPS (просмотр сообщений пользователем):

    DAU = 200 000 000
    Каждый пользователь в среднем просматривает сообщения 20 раз в сутки:
    RPS = 200 000 000 * 20 / 24 / 60 / 60 ~= 46 300



Требуемый размер хранилища:

    Будем считать что средний размер изображения в сообщении 250 КБ.
    Примем для расчётов среднее количество изображений в сообщении = 1.
    Средний размер сообщения с текстом примем = 750 символов.
    Возьмём промежуток времени равный 5 годам.

    Средний вес одного сообщения: 750 символов(текст) + мета информация(user_id, channel_id и т.д.) 300 B ~= 1KB.   
    Объём памяти: 200 000 000 * 10 * 365 * 5 * 1KB = 3.65e12B = 3.65ПB

    Так же в базе данных будут храниться метаданные пользователей, пример к расчёту вес данных для одного пользователя со всеми полями = 1кб.
    Примем для расчётов что количество пользователей приложения выросло на 25%,
    а 200 000 000 это лишь 3-я часть от общего количества пользователей. 
    Объём памяти: 200 000 000 * 3 + 25% = 750 000 000 * 1KB = 750 000 000KB = 750GB = 0.75TB

    Так же потребуется хранилище для изображений:
    Объём памяти: 200 000 000 * 10 * 365 * 5 * 250КБ = 9.125e17 Б = 912ПБ  

    В результате получаем общий объём хранилище за 5 лет: 3.65ПB + 0.75TB + 912ПБ = 915.7ПБ.